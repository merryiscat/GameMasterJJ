# **2. 상세 기능 명세 (Detailed Functional Specification)**

**참조 문서**: docs/0_architecture.md, docs/1_goal_scope_definition.md
**작성일**: 2025-09-17
**버전**: 1.0

## **2.1 다중 에이전트 시스템 기능**

### **FEAT-001: 오케스트레이터 에이전트 (Triage_GM_Agent)**
- **기능 설명**: 플레이어 입력을 해석하고 적절한 전문 에이전트에게 작업을 라우팅하는 중앙 관제 에이전트
- **트리거**: 플레이어의 모든 입력 (텍스트/음성)
- **처리 절차**:
  1. 플레이어 입력 수신 (텍스트 또는 STT 변환된 텍스트)
  2. 입력 의도 분석 ("공격한다", "대화한다", "세계관 질문" 등)
  3. 현재 게임 상태 확인 (Rules_Keeper_Agent 조회)
  4. 적절한 전문 에이전트 선택
  5. Handoffs를 통한 작업 위임
  6. 결과 수집 및 플레이어에게 전달
- **성공 조건**: 입력 의도가 95% 이상 정확하게 분류되어 올바른 에이전트로 라우팅
- **실패 조건**: 잘못된 에이전트 선택, 무한 루프, 응답 시간 초과 (5초)

### **FEAT-002: 내러티브 서술 에이전트 (Narrator_Agent)**
- **기능 설명**: 게임 장면, 환경, 행동 결과를 생동감 있게 묘사하는 전담 에이전트
- **트리거**: 오케스트레이터로부터 서술 요청 수신
- **처리 절차**:
  1. 현재 게임 상황 및 플레이어 행동 정보 수신
  2. 활성 스토리렛과 세계 상태 조회
  3. 일관된 톤앤매너로 장면 묘사 생성
  4. 플레이어의 행동 결과를 극적으로 서술
  5. 다음 행동을 위한 선택지 암시
- **성공 조건**: 일관된 문체, 세계관 설정 준수, 플레이어 몰입감 증대
- **실패 조건**: 설정 모순, 부자연스러운 서술, 중복적인 표현

### **FEAT-003: 규칙 관리 에이전트 (Rules_Keeper_Agent)**
- **기능 설명**: 모든 게임 규칙을 적용하고 게임 상태를 관리하는 결정론적 에이전트
- **트리거**: 규칙 판정이 필요한 모든 상황
- **처리 절차**:
  1. 판정 요청 및 관련 매개변수 수신
  2. 캐릭터 능력치/상태 조회 (get_stat 도구)
  3. 주사위 굴리기 실행 (roll_dice 도구)
  4. 게임 규칙에 따른 성공/실패 판정
  5. 게임 상태 업데이트 (set_stat, update_inventory 도구)
  6. 구조화된 결과 반환
- **성공 조건**: 100% 규칙 준수, 일관된 판정, 상태 정확성
- **실패 조건**: 규칙 위반, 상태 불일치, 도구 호출 실패

### **FEAT-004: NPC 상호작용 에이전트 (NPC_Interaction_Agent)**
- **기능 설명**: 모든 비플레이어 캐릭터의 대화, 행동, 반응을 전담 처리
- **트리거**: NPC와의 상호작용이 필요한 상황
- **처리 절차**:
  1. 대상 NPC 정보 및 상황 컨텍스트 수신
  2. NPC 성격, 동기, 관계 설정 적용
  3. 현재 상황에 적합한 NPC 반응 생성
  4. NPC의 말투, 어조, 행동 패턴 일관성 유지
  5. 플레이어와의 관계 변화를 상태로 반영
- **성공 조건**: NPC 개성 일관성, 상황 적절성, 캐릭터별 차별성
- **실패 조건**: 캐릭터 설정 모순, 동일한 반응 패턴, 상황 부적절성

### **FEAT-005: 세계관 관리 에이전트 (Lore_Keeper_Agent)**
- **기능 설명**: 게임 세계의 설정, 역사, 지식을 관리하고 플레이어 질문에 답변
- **트리거**: 세계관 관련 질문 또는 정보 필요 상황
- **처리 절차**:
  1. 플레이어의 세계관 질문 분석
  2. RAG 시스템을 통한 관련 설정 문서 검색
  3. 검색된 정보를 현재 상황에 맞게 가공
  4. 스포일러 방지를 위한 정보 필터링
  5. 플레이어 수준에 맞는 답변 생성
- **성공 조건**: 정확한 설정 정보 제공, 스포일러 방지, 몰입감 유지
- **실패 조건**: 잘못된 정보 제공, 스포일러 노출, 검색 실패

## **2.2 음성 상호작용 기능**

### **FEAT-006: 실시간 음성 인터페이스**
- **기능 설명**: 플레이어의 음성 입력을 받아 텍스트로 변환하고, AI 응답을 음성으로 출력
- **트리거**: 플레이어의 음성 입력 시작
- **처리 절차**:
  1. 마이크를 통한 실시간 오디오 캡처
  2. STT(Speech-to-Text) 엔진을 통한 음성-텍스트 변환
  3. 변환된 텍스트를 오케스트레이터 에이전트로 전달
  4. 에이전트 시스템의 텍스트 응답 수신
  5. TTS(Text-to-Speech) 엔진을 통한 텍스트-음성 변환
  6. 스피커를 통한 오디오 출력
- **성공 조건**: 정확한 음성 인식 (95% 이상), 자연스러운 음성 출력, 3초 이하 지연시간
- **실패 조건**: 음성 인식 실패, 오디오 출력 오류, 과도한 지연시간

### **FEAT-007: 음성 최적화 대화**
- **기능 설명**: 음성 출력에 최적화된 자연스러운 대화체 응답 생성
- **트리거**: 음성 모드에서의 모든 AI 응답
- **처리 절차**:
  1. 기본 텍스트 응답 생성
  2. 음성 출력을 위한 텍스트 최적화
  3. 대화체 변환 (구어체, 짧은 문장, 명확한 발음)
  4. 감정 톤 및 페이싱 조절
  5. TTS 엔진에 최적화된 포맷으로 변환
- **성공 조건**: 자연스러운 대화 흐름, 적절한 감정 표현, 명확한 발음
- **실패 조건**: 기계적인 음성, 부자연스러운 문장, 감정 표현 부족

## **2.3 스토리렛 기반 내러티브 시스템**

### **FEAT-008: 동적 스토리 선택 시스템**
- **기능 설명**: 현재 게임 상태에 따라 적절한 스토리렛을 동적으로 선택하고 실행
- **트리거**: 플레이어의 중요한 선택 또는 상황 변화
- **처리 절차**:
  1. 현재 게임 상태 및 플레이어 행동 분석
  2. 활성화 가능한 스토리렛 조건 확인
  3. 우선순위 및 적합성에 따른 스토리렛 선택
  4. 선택된 스토리렛의 사전조건 검증
  5. 스토리렛 실행 및 사후조건 적용
  6. 세계 상태 업데이트
- **성공 조건**: 상황에 적합한 스토리 진행, 플레이어 선택 반영, 일관된 결과
- **실패 조건**: 부적절한 스토리렛 선택, 조건 확인 실패, 상태 불일치

### **FEAT-009: 추상적 행동 구체화**
- **기능 설명**: 고수준 내러티브 목표를 현재 상황에 맞는 구체적 사건으로 변환
- **트리거**: 추상적 행동이 정의된 스토리렛 활성화
- **처리 절차**:
  1. 추상적 행동의 목표 및 제약 조건 분석
  2. 현재 게임 상태 및 캐릭터 정보 수집
  3. 상황에 맞는 구체적 사건 생성
  4. 플레이스홀더를 실제 게임 요소로 대체
  5. 생성된 사건의 적절성 검증
  6. 최종 구체화된 이벤트 실행
- **성공 조건**: 작가 의도 유지, 상황 적합성, 플레이어 몰입감
- **실패 조건**: 의도 왜곡, 부자연스러운 사건, 설정 모순

## **2.4 게임 규칙 및 상태 관리 기능**

### **FEAT-010: 주사위 시스템**
- **기능 설명**: 다양한 종류의 주사위 굴리기 및 수식 계산 지원
- **트리거**: 능력치 판정, 전투, 기타 확률적 상황
- **처리 절차**:
  1. 주사위 굴리기 요청 수신 (예: "2d6+3", "1d20")
  2. 주사위 수식 파싱 및 검증
  3. 암호학적으로 안전한 난수 생성
  4. 각 주사위 결과 계산 및 수식 적용
  5. 상세 결과 및 총합 반환
  6. 결과 로깅 및 히스토리 관리
- **성공 조건**: 정확한 확률 분포, 조작 불가능성, 결과 투명성
- **실패 조건**: 편향된 결과, 수식 오류, 시스템 조작 가능성

### **FEAT-011: 캐릭터 상태 관리**
- **기능 설명**: 플레이어 및 NPC의 능력치, 체력, 상태효과 등을 종합 관리
- **트리거**: 캐릭터 생성, 레벨업, 상태 변화 상황
- **처리 절차**:
  1. 캐릭터 정보 요청 수신
  2. 데이터베이스에서 현재 상태 조회
  3. 요청된 변경사항 검증 및 적용
  4. 파생 능력치 자동 계산 (예: AC, HP 등)
  5. 상태효과 및 만료 조건 확인
  6. 변경사항 데이터베이스 저장
- **성공 조건**: 데이터 일관성, 규칙 준수, 실시간 반영
- **실패 조건**: 데이터 손실, 불법적 수치 변경, 동기화 실패

### **FEAT-012: 인벤토리 및 아이템 시스템**
- **기능 설명**: 아이템 획득, 사용, 교환, 장비 등의 종합적 아이템 관리
- **트리거**: 아이템 관련 모든 행동
- **처리 절차**:
  1. 아이템 관련 행동 요청 분석
  2. 현재 인벤토리 상태 확인
  3. 아이템 속성 및 제약 조건 검증
  4. 요청된 행동의 가능성 판단
  5. 인벤토리 상태 업데이트
  6. 캐릭터 능력치에 미치는 영향 적용
- **성공 조건**: 아이템 속성 정확성, 무게/공간 제한 준수, 장비 효과 적용
- **실패 조건**: 아이템 복제, 제한 위반, 효과 미적용

## **2.5 사용자 인터페이스 기능**

### **FEAT-013: 실시간 채팅 인터페이스**
- **기능 설명**: 플레이어와 AI GM 간의 실시간 텍스트 대화 환경 제공
- **트리거**: 플레이어의 텍스트 입력
- **처리 절차**:
  1. 플레이어 메시지 수신 및 화면 표시
  2. 메시지를 오케스트레이터 에이전트로 전달
  3. AI 응답 실시간 스트리밍 수신
  4. 타이핑 인디케이터 및 응답 프로그레스 표시
  5. 완성된 응답 화면 렌더링
  6. 대화 히스토리 저장 및 관리
- **성공 조건**: 실시간 반응성, 직관적 UI, 메시지 순서 보장
- **실패 조건**: 메시지 누락, 순서 뒤섞임, UI 응답 지연

### **FEAT-014: 캐릭터 시트 관리**
- **기능 설명**: 캐릭터의 능력치, 기술, 장비 등을 시각적으로 관리하는 인터페이스
- **트리거**: 캐릭터 시트 조회 또는 수정 요청
- **처리 절차**:
  1. 캐릭터 데이터 로드 및 UI 렌더링
  2. 사용자 수정 요청 수신
  3. 입력값 검증 및 게임 규칙 확인
  4. Rules_Keeper_Agent를 통한 변경 승인
  5. UI 실시간 업데이트
  6. 변경사항 자동 저장
- **성공 조건**: 직관적 편집, 실시간 계산, 규칙 준수 안내
- **실패 조건**: 데이터 불일치, 규칙 위반 허용, 저장 실패

### **FEAT-015: 게임 세션 관리**
- **기능 설명**: 게임 저장, 불러오기, 히스토리 관리 등의 세션 제어 기능
- **트리거**: 게임 시작, 저장, 불러오기 요청
- **처리 절차**:
  1. 세션 관리 요청 분석
  2. 현재 게임 상태 스냅샷 생성
  3. 로컬 저장소에 데이터 저장/로드
  4. 게임 상태 복원 및 검증
  5. 에이전트 시스템 상태 동기화
  6. 플레이어에게 결과 알림
- **성공 조건**: 완벽한 상태 보존, 빠른 로딩, 데이터 무결성
- **실패 조건**: 데이터 손실, 상태 불일치, 로딩 실패

## **2.6 시스템 연동 기능**

### **FEAT-016: LLM API 통합**
- **기능 설명**: 외부 LLM API (GPT-4o-mini)와의 안정적인 통신 및 응답 처리
- **트리거**: 모든 AI 에이전트의 LLM 호출 요청
- **처리 절차**:
  1. 에이전트별 프롬프트 및 매개변수 설정
  2. API 호출 및 네트워크 오류 처리
  3. 응답 스트리밍 및 실시간 처리
  4. 응답 품질 검증 및 필터링
  5. 결과를 요청 에이전트로 반환
  6. API 사용량 모니터링
- **성공 조건**: 안정적 연결, 빠른 응답, 오류 복구
- **실패 조건**: 연결 실패, 응답 시간 초과, 품질 저하

### **FEAT-017: 로컬 데이터 저장**
- **기능 설명**: 모든 게임 데이터를 로컬 데이터베이스에 안전하게 저장 및 관리
- **트리거**: 게임 상태 변경 시
- **처리 절차**:
  1. 데이터 변경 이벤트 수신
  2. 데이터 검증 및 무결성 확인
  3. 트랜잭션을 통한 원자적 저장
  4. 백업 및 복구 지점 생성
  5. 저장 완료 확인 및 알림
  6. 주기적 데이터 정리 및 최적화
- **성공 조건**: 데이터 무결성, 트랜잭션 안전성, 성능 유지
- **실패 조건**: 데이터 손실, 트랜잭션 실패, 저장소 부족

## **2.7 품질 보장 기능**

### **FEAT-018: 가드레일 시스템**
- **기능 설명**: AI 응답의 품질, 적절성, 안전성을 검증하는 자동 필터링 시스템
- **트리거**: 모든 AI 응답 생성 시
- **처리 절차**:
  1. AI 응답 전문 분석
  2. 게임 톤앤매너 적합성 검증
  3. 부적절한 콘텐츠 필터링
  4. 설정 일관성 확인
  5. 필요시 응답 재생성 요청
  6. 최종 승인된 응답 전달
- **성공 조건**: 일관된 품질, 안전한 콘텐츠, 설정 준수
- **실패 조건**: 부적절한 응답 통과, 과도한 검열, 성능 저하

### **FEAT-019: 오류 복구 시스템**
- **기능 설명**: 시스템 오류 발생 시 자동 복구 및 안정성 보장
- **트리거**: 시스템 오류 또는 예외 상황 발생
- **처리 절차**:
  1. 오류 상황 감지 및 분류
  2. 게임 상태 백업본 확인
  3. 자동 복구 절차 실행
  4. 복구 실패 시 안전 모드 전환
  5. 사용자에게 상황 알림
  6. 오류 로그 기록 및 분석
- **성공 조건**: 빠른 복구, 데이터 보존, 사용자 경험 최소 영향
- **실패 조건**: 복구 실패, 데이터 손실, 시스템 불안정

## **2.8 성능 최적화 기능**

### **FEAT-020: 응답 시간 최적화**
- **기능 설명**: AI 응답 속도를 향상시키기 위한 다양한 최적화 기법 적용
- **트리거**: 모든 AI 상호작용 시
- **처리 절차**:
  1. 프롬프트 길이 및 복잡도 최적화
  2. 캐싱 가능한 응답 식별 및 저장
  3. 병렬 처리 가능한 작업 분산
  4. 응답 품질과 속도 균형 조절
  5. 네트워크 지연 최소화
  6. 성능 메트릭 모니터링
- **성공 조건**: 평균 3초 이하 응답, 일관된 성능, 품질 유지
- **실패 조건**: 응답 지연, 성능 저하, 품질 하락